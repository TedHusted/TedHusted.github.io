






<!doctype html>
<html lang="default">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="Ted Husted">
  
  
  
  
    <meta name="description" content="No software application is an island, and Salesforce provides two great mechanisms for getting data in and out of your org. To get bits in, there’s the Data Loader and other tools that use the same...">
  
  <title>Unloading Salesforce CRM Data with Outbound Messages [ ted.husted.com ]</title>
  
    <link rel="alternate" href="/atom.xml" title="ted.husted.com">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
  <link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/highlight-railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">
  
</head>

<body>
<div class="side-navigate hide-area">
  
    <div class="item prev">
      <a href="/2012/03/27/in-data-we-trust/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        In Data We Trust
      </div>
    </div>
  
  
    <div class="item next">
      <a href="/2012/03/20/learn-salesforce-now/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        Learn. Salesforce. Now.
      </div>
    </div>
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="http://2.gravatar.com/avatar/87a93952bc3587bbed2ab94ae88342af"/>
          <div id="homelink">ted.husted.com</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">Home</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">Posts</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">Categories</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">Tags</a>
            
          </li>
        
          
            <li>
          
            <a href="/about">About</a>
            
          </li>
        
          
            <li>
          
            <a href="https://github.com/TedHusted">Github</a>
            
          </li>
        
        </ul>
      </div>
      <div id="show-menu">
        <button>Menu</button>
      </div>
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  <article id="post">
    <h1>Unloading Salesforce CRM Data with Outbound Messages</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">Created at 2012-03-22</span>
      
        <span id = "post-title-updated">Updated at 2017-02-18</span>
      
      
      <span id = "post-title-categories">Category
      
      
        
        
        <a href="/categories/Tutorials/">Tutorials</a>
      
      </span>
      
      
      <span id = "post-title-tags">
      Tag
      
      
        
        
        <a href="/tags/Salesforce/">Salesforce</a>
      
      </span>
      
    </p>
    
    <div class="separator" style="clear:both;text-align:center;"><a href="http://www.clker.com/" target="_blank" rel="external"><img src="http://www.clker.com/cliparts/6/9/f/3/11971239071443233733nicubunu_Message_in_a_Bottle.svg.med.png" alt=""></a></div>No software application is an island, and Salesforce provides two great mechanisms for getting data in and out of your org. To get bits in, there’s the Data Loader and other tools that use the same APIs. To get data out, Salesforce provides a system for pushing outbound messages to an external web service.<br><br>Whenever data is edited, or some other internal event occurs, a Salesforce workflow can queue an outbound message to another system.<br><br>While there are several off-the-shelf tools for loading data, implementing an outbound message listener is still a custom affair that requires database and web development skills. If you don’t mind exposing an end-point to pass data to a stored procedure, then read on ..<br><br><a name="more"></a>There are plenty of devils in the details, but here’s the basic 1-2-3-4:<br><br>1.  A workflow rule queues an outbound message.<br>2.  The outbound message contains a bundle of fields from one of your Salesforce objects.<br>3.  A web service endpoint (that you create) receives the message and updates an external system (that you control).<br>4.  Optionally, the service responds and updates the original recordThe linch pin is step 3. While there are tools that simplify writing web services, you still need to write some code. The Salesforce API Developers Guide provides an <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_om_outboundmessaging_listener.htm" target="_blank" rel="external">example of a simple listener class</a>, but it’s really a bit too simple.<br><div><br><pre>classMyNotificationListener : INotificationBinding<br>{<br>    publicnotificationsResponse notifications(notifications n)<br>    {<br>        notificationsResponse r = newnotificationsResponse();<br>        r.Ack = true;<br>        return r;<br>    }<br>}<br></pre><br>The notificationsResponse method is the end-point for a SOAP web services call. The message bundle is passed over as a “notification”.  If records are being updated in bulk (say by a data loader), Salesforce may include up to 100 notifications in a single SOAP envelope.   A better example of a notificationResponse would be:<br><br><pre><span class="Apple-style-span">classMyNotificationListener : INotificationBinding<br>{<br>    publicnotificationsResponse notifications(notifications n)<br>    {<br>        foreach (AccountNotification message in n.Notification)<br>        {<br>            // … handle message …</span><span class="Apple-style-span"><br>        }<br>        notificationsResponse r = newnotificationsResponse();<br>        r.Ack = true;<br>        return r;<br>    }<br>}<br></span></pre><br>Something to consider when handling a message is that Salesforce may send the same message multiple times. Each message has an ID, and if handling the same message twice would be a bad thing, you should cache the ID and check it before processing. Also, in real life, we should catch exceptions and log errors.<br><br><pre>log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);<br>foreach (AccountNotification message in n.Notification)<br>{<br>  sf = message.sObject;<br>  try<br>  {<br>    // – Have we met? –<br>    if (HttpRuntime.Cache[message.Id] != null)<br>    {<br>      log.Warn(string.Format(“Warn: SKIPPING (sf.id=\”{0}\”) in message (id=\”{1}\”)”, sf.Id, message.Id));<br>      continue;<br>    }<br>    lock (cacheLock)<br>    {<br>      // The cache will only last as long as the App Pool<br>      HttpRuntime.Cache.Insert(message.Id, sf.Id, null, System.Web.Caching.Cache.NoAbsoluteExpiration, TimeSpan.FromHours(2));<br>      log.Info(string.Format(“Info: PROCESSING (sf.id=\”{0}\”) in message (id=\”{1}\”)”,sf.Id, message.Id));<br>    }<br><br>    // … handle message …<br>  }<br>  catch (Exception ex)<br>  {<br>    // Catch any exceptions raised in foreach loop<br>    String errorMessage = ex.Message + “ — “ + ex.StackTrace;<br>    log.Error(String.Format(“Error: EXCEPTION (sf.id=\”{0}\”, error=\”{1}\””, sf.Id, ex.Message + “ — “ + ex.StackTrace));<br>        }<br>} // end foreach loop<br></pre><br>When developing an outbound message service, you should test it under maximum load. What will happen if someone uses the Apex Dataloader to touch every record in an object, potentially creating an outbound message for every record? If that happens, Salesforce is going to collect the bundles into envelopes of 100 records each, and send them down to your web service as quickly as it can. If your service can’t keep up, Salesforce will try again later, in increasing intervals, for up to 24 hours.<br><br>Under “Setup/Monitor/Outbound Messages”, Salesforce provides a display where you can watch the records pass through in real time. If in your tests, you see Salesforce binding up, it’s a good idea to queue the records, and process them at your system’s pace.<br><br>For .NET, one approach would be to spread-out the work using a ThreadPool, but a better approach can be to use a Producer/Consumer Queue. (The example code is written for .NET 3.5. A 4.0 implementation may differ. See <a href="http://www.amazon.com/gp/product/0596800959/ref=as_li_ss_tl?ie=UTF8&amp;tag=husteddotcom-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0596800959" target="_blank" rel="external">C# 4.0 in a Nutshell</a> for more examples and background information.)<br><br><pre>public notificationsResponse notifications(notifications n)<br>{<br>  log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);<br>  if (myQueue == null) lock (queueLock)<br>  {<br>    // Double-check pattern<br>    if (myQueue == null) myQueue = new AccountQueue();<br>  }<br>  log.Info(“Info: Enqueuing and acknowledging notifications”);<br>  myQueue.EnqueueTask(n);<br>  notificationsResponse r = new notificationsResponse();<br>  r.Ack = true;<br>  return r;<br>}<br><br>// Producer/Consumer Queue to throttle account upserts notifications<br>// and prevent swamping of server during DataLoader updates.<br>// <a href="http://www.albahari.com/threading/part2.aspx#_WaitHandle_Producer_Consumer_Queue" target="_blank" rel="external">http://www.albahari.com/threading/part2.aspx#_WaitHandle_Producer_Consumer_Queue</a><br>class AccountQueue : IDisposable<br>{<br>  EventWaitHandle _wh = new AutoResetEvent(false);<br>  Thread _worker;<br>  readonlyobject _locker = newobject();<br>  Queue _tasks = new Queue();<br>  public AccountQueue()<br>  {<br>    _worker = new Thread(Work);<br>    _worker.Start();<br>  }<br>  publicvoid EnqueueTask(notifications task)<br>  {<br>    lock (_locker) _tasks.Enqueue(task);<br>    _wh.Set();<br>  }<br>    publicvoid Dispose()<br>    {<br>        EnqueueTask(null);     // Signal the consumer to exit.<br>        _worker.Join();        // Wait for the consumer’s thread to finish.<br>        _wh.Close();           // Release any OS resources.<br>    }<br>    void Work()<br>    {<br>    while (true)<br>    {<br>      notifications task = null;<br>      lock (_locker)<br>        if (_tasks.Count &gt; 0)<br>        {<br>           task = _tasks.Dequeue();<br>           if (task == null) return;<br>        }<br>        if (task != null)<br>        {<br>          doWork(task);    // Handle message here<br>        }<br>        else<br>          _wh.WaitOne();   // No more tasks - wait for a signal<br>      }<br>   }<br>}<br><br>static readonly private object cacheLock = newobject();<br>static public void doWork(notifications n) {<br>     // … code from prior example …<br>}<br></pre><br>Along the way, we slipped in a reference to Log4Net. Configuring Log4Net is outside the scope of this article, but you can dig into the gory details at <a href="http://logging.apache.org/" target="_blank" rel="external">logging.apache.org</a>. Highly recommended!<br><br>While our non-trivial example has grown quickly, it does provide the backbone for a robust Listener that can keep pace with Salesforce, even when you are stuck with a pokey API or under-powered server.<br><br>In a <a href="http://tedhusted.blogspot.com/2012/03/catch-me-on-flip-side-responding-to.html" target="_blank" rel="external">followup blog</a>, we close the loop by showing how a listener can respond back to Salesforce.<br><br></div>
  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">Show TOC</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">Hide TOC</button>
  <div class="random-toc">
    <h2>Table of Content</h2>
    
  </div>
</div>

  
<nav id="pagination">
  
    <a href="/2012/03/27/in-data-we-trust/" class="prev">&larr; Prev post In Data We Trust</a>
  

  

  
    <a href="/2012/03/20/learn-salesforce-now/" class="next">Next post Learn. Salesforce. Now. &rarr;</a>
  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
      
      <div id="disqus_thread"></div>
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Ted Husted using
      <a href="http://hexo.io">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random">Random</a>
      <br>
      
    </div>
  </div>
</div>

</div>


  <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//ted-husted-com.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="http://2.gravatar.com/avatar/87a93952bc3587bbed2ab94ae88342af">
    <p id="description">Ted Husted is a coder, writer, and speaker. All told, Ted has been creating and deploying business applications since 1984, first for the desktop, then for the Internet, and now for the Cloud.</p>
    <ul class="social-icon">
  
  
    <li>
      <a href="https://github.com/TedHusted">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://twitter.com/TedHusted">
        
          <i class="icon iconfont twitter">&#xe600;</i>
        
      </a>
    </li>
  
    <li>
      <a href="http://ted.husted.com/feed">
        
          <i class="icon iconfont rss">&#xe60e;</i>
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>


  <script>
if(isTriggerAnalytics) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '92185980', 'auto');
  ga('send', 'pageview');
}

</script>



  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = "";
var unsplashConfig = "";
// is show background images
var turnoffBackgroundImage = false;



  turnoffBackgroundImage = true;


var backgroundColor = "34495E";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

