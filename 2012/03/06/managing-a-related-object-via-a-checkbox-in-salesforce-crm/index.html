






<!doctype html>
<html lang="default">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="Ted Husted">
  
  
  
  
    <meta name="description" content="This Force.com recipe shows how to use a checkbox to manage a related object via an Apex trigger. 
Problem: An off-the-shelf integration requires the existence  of a specific Salesforce CRM Opportu...">
  
  <title>Managing a Related Object via a Checkbox in Salesforce CRM [ ted.husted.com ]</title>
  
    <link rel="alternate" href="/atom.xml" title="ted.husted.com">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
  <link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/highlight-railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">
  
</head>

<body>
<div class="side-navigate hide-area">
  
    <div class="item prev">
      <a href="/2012/03/12/salesforce-certification-a-winwin/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        Salesforce Certification - A Win/Win
      </div>
    </div>
  
  
    <div class="item next">
      <a href="/2012/03/05/test-driven-development-with-apex-triggers-on-force-com/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        Test Driven Development with Apex Triggers on Force.com
      </div>
    </div>
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="http://2.gravatar.com/avatar/87a93952bc3587bbed2ab94ae88342af"/>
          <div id="homelink">ted.husted.com</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">Home</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">Posts</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">Categories</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">Tags</a>
            
          </li>
        
          
            <li>
          
            <a href="/about">About</a>
            
          </li>
        
          
            <li>
          
            <a href="https://github.com/TedHusted">Github</a>
            
          </li>
        
        </ul>
      </div>
      <div id="show-menu">
        <button>Menu</button>
      </div>
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  <article id="post">
    <h1>Managing a Related Object via a Checkbox in Salesforce CRM</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">Created at 2012-03-06</span>
      
        <span id = "post-title-updated">Updated at 2017-02-18</span>
      
      
      <span id = "post-title-categories">Category
      
      
        
        
        <a href="/categories/Tutorials/">Tutorials</a>
      
      </span>
      
      
      <span id = "post-title-tags">
      Tag
      
      
        
        
        <a href="/tags/Salesforce/">Salesforce</a>
      
      </span>
      
    </p>
    
    <p><div class="separator" style="clear:both;text-align:center;"><a href="http://suvendugiri.wordpress.com/2012/02/09/android-using-checkbox-with-example/" target="_blank" rel="external"><img src="http://suvendugiri.files.wordpress.com/2012/02/checkbox.png" alt=""></a></div>This Force.com recipe shows how to use a checkbox to manage a related object via an Apex trigger. </p>
<p><strong>Problem: </strong>An off-the-shelf integration requires the existence  of a specific Salesforce CRM Opportunity object. When the object is  present, the integration acts on the Account related to the Opportunity.  When the object is not present. the integration bypasses the Account.</p>
<p><strong>User Story:</strong> As a CRM User, I need to easily manage the Opportunity that signals the  integration, for example, by selecting a checkbox that creates or  removes the related integration object.</p>
<p><strong>Solution:</strong> Implement an Account trigger that observes the checkbox and inserts or deletes the related integration object.</p>
<p><div><strong><span style="font-size:x-small;"></span></strong><br><a name="more"></a><strong><span style="font-size:x-small;">// trigger class</span></strong></div><div><span style="font-size:x-small;"><br>/** </span></div></p>
<ul>
<li>Manages a2z Opportunity by referring to the </li>
<li>“Is a2z Import” checkbox on the Account object. </li>
<li>When an a2z Opportunity exists, the Account is imported to a2z. </li>
<li>The trigger handles three transitional states: </li>
<li>(1) if insert and doImport, insert opp; </li>
<li>(2) if update and !doImport and hasOpp, delete opp;    </li>
<li>(3) if update and doImport and !hasOpp, insert opp.</li>
<li>By inference, the trigger also handles:</li>
<li>(4) if insert and !doImport, exit; </li>
<li>(5) if update and doImport and hasOpp, exit;</li>
<li><p>(6) if !doImport and !hasOpp, exit.<br>*/<br>trigger NU_a2zCreateOpportunity on Account (after insert, after update) {</p>
<p> // (1) On insert, if isImport, insert opp<br> if (Trigger.isInsert) {</p>
<pre><code>List delta = new List();
for (Account a : Trigger.new) {
    if (a.NU_isA2zImport__c) {
        delta.add(NU_a2zOpps.newOpp(a));
    }        
}
if (delta.size()&amp;gt;0) insert(delta);
</code></pre><p> }</p>
<p> // (2) On update, if not isImport and haveOpp, delete opp<br> // (3) On update, if isImport and not haveOpp, insert opp<br> if (Trigger.isUpdate) {</p>
<pre><code>if (Trigger.new.size() == 1) {
    Account a = Trigger.new.get(0);
    Boolean hasOpp = NU_a2zOpps.hasOpp(a);
    if (!a.NU_isA2zImport__c &amp;amp;&amp;amp; hasOpp) {
        delete(NU_a2zOpps.getOpp(a)); // (2)
    }  
    if (a.NU_isA2zImport__c &amp;amp;&amp;amp; !hasOpp) {
        insert(NU_a2zOpps.newOpp(a)); // (3)
    }    

} else {
    Map opps = NU_a2zOpps.getOpps(Trigger.new);
    Set ids = opps.Keyset();
    Set dels = new Set();
    List deletes = new List();
    List inserts = new List();
    for (Account a : Trigger.new) {
        if (!a.NU_isA2zImport__c &amp;amp;&amp;amp; ids.contains(a.Id)) {
            deletes.add(opps.get(a.Id)); // (2)
        }  
        if (a.NU_isA2zImport__c &amp;amp;&amp;amp; !ids.contains(a.Id)) {
            inserts.add(NU_a2zOpps.newOpp(a)); // (3)
        }    
    } 
    if (deletes.size()&amp;gt;0) delete(deletes);
    if (inserts.size()&amp;gt;0) insert(inserts);
}
</code></pre><p> }<br>}<div><strong>
</strong><br><strong>
</strong></div><span style="font-size:x-small;"><strong><span style="font-family:'Courier New', Courier, monospace;">// test class</span></strong><br><span style="font-family:'Courier New', Courier, monospace;"></span></span></p>
</li>
</ul>
<p><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">/**</span></span></p>
<ul>
<li><p>Exercises the a2zCreateOpportunity feature set.<br>*/<br>@isTest<br>private class NU_TEST_a2zCreateOpportunity {</p>
<p> /** </p>
<ul>
<li>Generates a key based on system time and offset.</li>
<li><p>Sufficient for unit test purposes only.<br>*/<br>static String newCompanyNumber(Integer offset, String kicker) {<br> Datetime n = Datetime.now();<br> return kicker + String.valueOf(n.minute()) + String.valueOf(n.millisecond()) + String.valueOf(offset);<br>} </p>
<p>/**</p>
</li>
<li>Generates an account with the NU_isA2zImport__c raised or lowered.</li>
<li><p>Assumes default is false.<br>*/<br>static Account newAccount(Boolean doImport, Integer offset, String kicker) {<br> Account a = new Account(Name = ‘Test Account’, </p>
<pre><code>CompanyNumber__c = newCompanyNumber(offset, kicker));
</code></pre><p> if (doImport) a.NU_isA2zImport__c = true; // False is default<br> return a;<br>}</p>
<p>/**</p>
</li>
<li>Generates an account with the NU_isA2zImport__c raised or lowered.</li>
<li><p>Assumes default is false.<br>*/<br>static Account newAccount(Boolean doImport) {<br> return newAccount(doImport, 0, ‘’);<br>}</p>
<p>/** </p>
</li>
<li><p>Inserts the given account, and returns it again from a select.<br>*/<br>static Account doInsert(Account a) {<br> insert(a);<br> return [<br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">FROM Account<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">WHERE id = :a.id</span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">];<br>}</span></span></p>
<p>/** </p>
</li>
<li><p>Exercises “Insert Import”.<br>*/<br>static testMethod void testInsImp(){<br> Account a = newAccount(true);<br> Account a2 = doInsert(a);<br> System.Assert(NU_a2zOpps.hasOpp(a2),’Expected opp on insert.’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Insert NoImport”.<br>*/<br>static testMethod void testInsNoImp(){<br> Account a = newAccount(false);<br> Account a2 = doInsert(a);<br> System.Assert(!NU_a2zOpps.hasOpp(a2),’Expected no opps on insert.’);<br>}</p>
<p>/**</p>
</li>
<li>Creates, inserts, and updates an account, </li>
<li><p>changing the import settings in between.<br>*/<br>static void updateHelper(Boolean insImp, Boolean updImp) {<br> Account a = newAccount(insImp);<br> Account a2 = doInsert(a);<br> a2.NU_isA2zImport__c = updImp;<br> update(a2);<br> if (updImp) {</p>
<pre><code>System.Assert(NU_a2zOpps.hasOpp(a2),&apos;Expected opps on update.&apos;);
</code></pre><p> } else {</p>
<pre><code>System.Assert(!NU_a2zOpps.hasOpp(a2),&apos;Expected no opps on update.&apos;);
</code></pre><p> }<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update ImportNoImport”.<br>*/<br>static testMethod void testUpdImpNoImp(){<br> updateHelper(true,false);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update NoImportImport”.<br>*/<br>static testMethod void testUpdNoImpImp(){<br> updateHelper(false,true);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update ImportImport”.<br>*/<br>static testMethod void testUpdImpImp(){<br> updateHelper(true,true);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update NoImportNoImport”.<br>*/<br>static testMethod void testUpdNoImpNoImp(){<br> updateHelper(false,false);<br>}</p>
<p>static List getInserted(List rows) {<br> return [<span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">FROM Account </span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">WHERE id in :rows</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><br> </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">];<br>}</span></span></p>
<p>/** </p>
</li>
<li><p>Creates, inserts, and updates an account,<br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">     <em> </em></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">changing the import settings in between, for a batch of accounts.
/<br>static void batchHelper(Boolean insImp, Boolean updImp,<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">Boolean contains, String kicker) {<br> List rows = new List();<br> for (Integer r=0; r&lt;200; r++) {</span></span></p>
<pre><code>rows.add(newAccount(insImp, r, kicker));
</code></pre><p> }<br> insert(rows);<br> List inserted = getInserted(rows);<br> // In Apex, anything can be null<br> if (updImp != null) {</p>
<pre><code>for (Account a : inserted) {
    a.NU_isA2zImport__c = updImp;            
}
</code></pre><p> }<br> update(inserted);<br> Set ids = NU_a2zOpps.getOpps(inserted).Keyset();<br> Boolean success = true;<br> if (contains) {</p>
<pre><code>for (Account a : inserted) {
    success = success &amp;amp;&amp;amp; ids.contains(a.Id);            
}
System.Assert(success,&apos;Expected opps on batch delete.&apos;);
</code></pre><p> } else { </p>
<pre><code>for (Account a : inserted) {
    success = success &amp;amp;&amp;amp; !ids.contains(a.Id);            
}
System.Assert(success,&apos;Expected no opps on batch delete.&apos;);        
</code></pre><p> }<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Batch has flag set”.<br>*/<br>static testMethod void batchHelperHas() {<br> batchHelper(true,null,true,’A’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Batch does not have flag set”.<br>*/<br>static testMethod void batchHelperHasNot() {<br> batchHelper(false,null,false,’B’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises Batch delete.<br>*/<br>static testMethod void batchHelperDel() {<br> batchHelper(true,false,false,’C’);<br>}</p>
<p>/** </p>
</li>
<li>Exercises Batch insert.<br>*/<br>static testMethod void batchHelperIns() {<br> batchHelper(false,true,true,’D’);<br>}<br>}</li>
</ul>
</li>
</ul>

  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">Show TOC</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">Hide TOC</button>
  <div class="random-toc">
    <h2>Table of Content</h2>
    
  </div>
</div>

  
<nav id="pagination">
  
    <a href="/2012/03/12/salesforce-certification-a-winwin/" class="prev">&larr; Prev post Salesforce Certification - A Win/Win</a>
  

  

  
    <a href="/2012/03/05/test-driven-development-with-apex-triggers-on-force-com/" class="next">Next post Test Driven Development with Apex Triggers on Force.com &rarr;</a>
  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
      
      <div id="disqus_thread"></div>
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Ted Husted using
      <a href="http://hexo.io">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random">Random</a>
      <br>
      
    </div>
  </div>
</div>

</div>


  <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//ted-husted-com.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="http://2.gravatar.com/avatar/87a93952bc3587bbed2ab94ae88342af">
    <p id="description">Ted Husted is a coder, writer, and speaker. All told, Ted has been creating and deploying business applications since 1984, first for the desktop, then for the Internet, and now for the Cloud.</p>
    <ul class="social-icon">
  
  
    <li>
      <a href="http://ted.husted.com/atom.xml">
        
          <i class="icon iconfont rss">&#xe60e;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://twitter.com/TedHusted">
        
          <i class="icon iconfont twitter">&#xe600;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://github.com/TedHusted">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>


  <script>
if(isTriggerAnalytics) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '92185980', 'auto');
  ga('send', 'pageview');
}

</script>



  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = "";
var unsplashConfig = "";
// is show background images
var turnoffBackgroundImage = false;



  turnoffBackgroundImage = true;


var backgroundColor = "34495E";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

