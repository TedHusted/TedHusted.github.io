<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ted.husted.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Ted Husted is a coder, writer, and speaker. All told, Ted has been creating and deploying business applications since 1984, first for the desktop, then for the Internet, and now for the Cloud.">
<meta property="og:type" content="website">
<meta property="og:title" content="ted.husted.com">
<meta property="og:url" content="http://ted.husted.com/page/10/index.html">
<meta property="og:site_name" content="ted.husted.com">
<meta property="og:description" content="Ted Husted is a coder, writer, and speaker. All told, Ted has been creating and deploying business applications since 1984, first for the desktop, then for the Internet, and now for the Cloud.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ted.husted.com">
<meta name="twitter:description" content="Ted Husted is a coder, writer, and speaker. All told, Ted has been creating and deploying business applications since 1984, first for the desktop, then for the Internet, and now for the Cloud.">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '92185980', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">RSS</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://ted.husted.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer">
      <article id="post-salesforce-certification-a-winwin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/salesforce-certification-a-winwin/">Salesforce Certification - A Win/Win</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2012/salesforce-certification-a-winwin/" class="article-date">
  <time datetime="2012-03-12T09:00:00.000Z" itemprop="datePublished">2012-03-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/review/">Review</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><div class="separator" style="clear:both;text-align:center;"><a href="http://www.absolutelyfengshui.com/fengshui/feng-shui-yin-yang.php" target="_blank" rel="external"><img src="http://www.absolutelyfengshui.com/images/yin-yang-symbol.jpg" alt=""></a></div>General knowledge of database or website technologies is invaluable, but at the the end of the day, we implement projects in specific products. A Ph.D. in computer science doesn’t mean someone is a SQL Server 2008 rock star.</p>
<p>A key benefit of working with Salesforce CRM is a top-knotch professional certification program that recognizes individuals who have passed detailed proficiency exams. Salesforce.com offers two distinct certification paths, Administrator and Developer.</p>
<p>Certified Administrators employ broad knowledge of the Salesforce CRM platform. Administrators provide first-tier support for other users, create reports and dashboards, define validations, construct workflows and approval processes, and handle the day-to-day oversight of a Salesforce organization.</p>
<p><a name="more"></a>Certified Developers evince comprehensive knowledge of the Force.com development platform. Developers create custom objects, database triggers, Visualforce pages, and other custom components. Developers may also work with the web services API to integrate Salesforce CRM with other products.</p>
<p>To prove higher levels of proficiency, Certified Administrators may earn additional credentials as Sales or Service Cloud Implementation Experts, and Certified Developers can go on to earn a Technical Architect credential. For the overachiever, there are also Advanced Administrator and Advanced Developer certifications.</p>
<p>Since Salesforce.com releases significant new enhancements to the platform every four months, like clockwork, we all have to maintain our certifications by taking release-specific exams, for each certification. The maintenance exams are not as grueling as the initial exams, but earning and keeping certifications demonstrates commitment to the Salesforce platform.</p>
<p>At NimbleUser, our Salesforce implementation teams include a mix of Certified Administrators and Certified Developers. Having certified consultants on board helps us provide our customers with the highest possible level of service.</p>
<p>Visit <a href="http://certification.salesforce.com/" target="_blank" rel="external">certification.salesforce.com </a>to learn more, or visit the <a href="http://nimbleuser.com/meet-the-staff/" target="_blank" rel="external">NimbleUser web site</a> to find out more about the peeps.</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/salesforce/">Salesforce</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-managing-a-related-object-via-a-checkbox-in-salesforce-crm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/managing-a-related-object-via-a-checkbox-in-salesforce-crm/">Managing a Related Object via a Checkbox in Salesforce CRM</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2012/managing-a-related-object-via-a-checkbox-in-salesforce-crm/" class="article-date">
  <time datetime="2012-03-06T11:00:00.000Z" itemprop="datePublished">2012-03-06</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/tutorial/">Tutorial</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><div class="separator" style="clear:both;text-align:center;"><a href="http://suvendugiri.wordpress.com/2012/02/09/android-using-checkbox-with-example/" target="_blank" rel="external"><img src="http://suvendugiri.files.wordpress.com/2012/02/checkbox.png" alt=""></a></div>This Force.com recipe shows how to use a checkbox to manage a related object via an Apex trigger. </p>
<p><strong>Problem: </strong>An off-the-shelf integration requires the existence  of a specific Salesforce CRM Opportunity object. When the object is  present, the integration acts on the Account related to the Opportunity.  When the object is not present. the integration bypasses the Account.</p>
<p><strong>User Story:</strong> As a CRM User, I need to easily manage the Opportunity that signals the  integration, for example, by selecting a checkbox that creates or  removes the related integration object.</p>
<p><strong>Solution:</strong> Implement an Account trigger that observes the checkbox and inserts or deletes the related integration object.</p>
<p><div><strong><span style="font-size:x-small;"></span></strong><br><a name="more"></a><strong><span style="font-size:x-small;">// trigger class</span></strong></div><div><span style="font-size:x-small;"><br>/** </span></div></p>
<ul>
<li>Manages a2z Opportunity by referring to the </li>
<li>“Is a2z Import” checkbox on the Account object. </li>
<li>When an a2z Opportunity exists, the Account is imported to a2z. </li>
<li>The trigger handles three transitional states: </li>
<li>(1) if insert and doImport, insert opp; </li>
<li>(2) if update and !doImport and hasOpp, delete opp;    </li>
<li>(3) if update and doImport and !hasOpp, insert opp.</li>
<li>By inference, the trigger also handles:</li>
<li>(4) if insert and !doImport, exit; </li>
<li>(5) if update and doImport and hasOpp, exit;</li>
<li><p>(6) if !doImport and !hasOpp, exit.<br>*/<br>trigger NU_a2zCreateOpportunity on Account (after insert, after update) {</p>
<p> // (1) On insert, if isImport, insert opp<br> if (Trigger.isInsert) {</p>
<pre><code>List delta = new List();
for (Account a : Trigger.new) {
    if (a.NU_isA2zImport__c) {
        delta.add(NU_a2zOpps.newOpp(a));
    }        
}
if (delta.size()&amp;gt;0) insert(delta);
</code></pre><p> }</p>
<p> // (2) On update, if not isImport and haveOpp, delete opp<br> // (3) On update, if isImport and not haveOpp, insert opp<br> if (Trigger.isUpdate) {</p>
<pre><code>if (Trigger.new.size() == 1) {
    Account a = Trigger.new.get(0);
    Boolean hasOpp = NU_a2zOpps.hasOpp(a);
    if (!a.NU_isA2zImport__c &amp;amp;&amp;amp; hasOpp) {
        delete(NU_a2zOpps.getOpp(a)); // (2)
    }  
    if (a.NU_isA2zImport__c &amp;amp;&amp;amp; !hasOpp) {
        insert(NU_a2zOpps.newOpp(a)); // (3)
    }    

} else {
    Map opps = NU_a2zOpps.getOpps(Trigger.new);
    Set ids = opps.Keyset();
    Set dels = new Set();
    List deletes = new List();
    List inserts = new List();
    for (Account a : Trigger.new) {
        if (!a.NU_isA2zImport__c &amp;amp;&amp;amp; ids.contains(a.Id)) {
            deletes.add(opps.get(a.Id)); // (2)
        }  
        if (a.NU_isA2zImport__c &amp;amp;&amp;amp; !ids.contains(a.Id)) {
            inserts.add(NU_a2zOpps.newOpp(a)); // (3)
        }    
    } 
    if (deletes.size()&amp;gt;0) delete(deletes);
    if (inserts.size()&amp;gt;0) insert(inserts);
}
</code></pre><p> }<br>}<div><strong>
</strong><br><strong>
</strong></div><span style="font-size:x-small;"><strong><span style="font-family:'Courier New', Courier, monospace;">// test class</span></strong><br><span style="font-family:'Courier New', Courier, monospace;"></span></span></p>
</li>
</ul>
<p><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">/**</span></span></p>
<ul>
<li><p>Exercises the a2zCreateOpportunity feature set.<br>*/<br>@isTest<br>private class NU_TEST_a2zCreateOpportunity {</p>
<p> /** </p>
<ul>
<li>Generates a key based on system time and offset.</li>
<li><p>Sufficient for unit test purposes only.<br>*/<br>static String newCompanyNumber(Integer offset, String kicker) {<br> Datetime n = Datetime.now();<br> return kicker + String.valueOf(n.minute()) + String.valueOf(n.millisecond()) + String.valueOf(offset);<br>} </p>
<p>/**</p>
</li>
<li>Generates an account with the NU_isA2zImport__c raised or lowered.</li>
<li><p>Assumes default is false.<br>*/<br>static Account newAccount(Boolean doImport, Integer offset, String kicker) {<br> Account a = new Account(Name = ‘Test Account’, </p>
<pre><code>CompanyNumber__c = newCompanyNumber(offset, kicker));
</code></pre><p> if (doImport) a.NU_isA2zImport__c = true; // False is default<br> return a;<br>}</p>
<p>/**</p>
</li>
<li>Generates an account with the NU_isA2zImport__c raised or lowered.</li>
<li><p>Assumes default is false.<br>*/<br>static Account newAccount(Boolean doImport) {<br> return newAccount(doImport, 0, ‘’);<br>}</p>
<p>/** </p>
</li>
<li><p>Inserts the given account, and returns it again from a select.<br>*/<br>static Account doInsert(Account a) {<br> insert(a);<br> return [<br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">FROM Account<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">WHERE id = :a.id</span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">];<br>}</span></span></p>
<p>/** </p>
</li>
<li><p>Exercises “Insert Import”.<br>*/<br>static testMethod void testInsImp(){<br> Account a = newAccount(true);<br> Account a2 = doInsert(a);<br> System.Assert(NU_a2zOpps.hasOpp(a2),’Expected opp on insert.’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Insert NoImport”.<br>*/<br>static testMethod void testInsNoImp(){<br> Account a = newAccount(false);<br> Account a2 = doInsert(a);<br> System.Assert(!NU_a2zOpps.hasOpp(a2),’Expected no opps on insert.’);<br>}</p>
<p>/**</p>
</li>
<li>Creates, inserts, and updates an account, </li>
<li><p>changing the import settings in between.<br>*/<br>static void updateHelper(Boolean insImp, Boolean updImp) {<br> Account a = newAccount(insImp);<br> Account a2 = doInsert(a);<br> a2.NU_isA2zImport__c = updImp;<br> update(a2);<br> if (updImp) {</p>
<pre><code>System.Assert(NU_a2zOpps.hasOpp(a2),&apos;Expected opps on update.&apos;);
</code></pre><p> } else {</p>
<pre><code>System.Assert(!NU_a2zOpps.hasOpp(a2),&apos;Expected no opps on update.&apos;);
</code></pre><p> }<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update ImportNoImport”.<br>*/<br>static testMethod void testUpdImpNoImp(){<br> updateHelper(true,false);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update NoImportImport”.<br>*/<br>static testMethod void testUpdNoImpImp(){<br> updateHelper(false,true);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update ImportImport”.<br>*/<br>static testMethod void testUpdImpImp(){<br> updateHelper(true,true);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Update NoImportNoImport”.<br>*/<br>static testMethod void testUpdNoImpNoImp(){<br> updateHelper(false,false);<br>}</p>
<p>static List getInserted(List rows) {<br> return [<span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">FROM Account </span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">            </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">WHERE id in :rows</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><br> </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">];<br>}</span></span></p>
<p>/** </p>
</li>
<li><p>Creates, inserts, and updates an account,<br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">     <em> </em></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">changing the import settings in between, for a batch of accounts.
/<br>static void batchHelper(Boolean insImp, Boolean updImp,<br></span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">Boolean contains, String kicker) {<br> List rows = new List();<br> for (Integer r=0; r&lt;200; r++) {</span></span></p>
<pre><code>rows.add(newAccount(insImp, r, kicker));
</code></pre><p> }<br> insert(rows);<br> List inserted = getInserted(rows);<br> // In Apex, anything can be null<br> if (updImp != null) {</p>
<pre><code>for (Account a : inserted) {
    a.NU_isA2zImport__c = updImp;            
}
</code></pre><p> }<br> update(inserted);<br> Set ids = NU_a2zOpps.getOpps(inserted).Keyset();<br> Boolean success = true;<br> if (contains) {</p>
<pre><code>for (Account a : inserted) {
    success = success &amp;amp;&amp;amp; ids.contains(a.Id);            
}
System.Assert(success,&apos;Expected opps on batch delete.&apos;);
</code></pre><p> } else { </p>
<pre><code>for (Account a : inserted) {
    success = success &amp;amp;&amp;amp; !ids.contains(a.Id);            
}
System.Assert(success,&apos;Expected no opps on batch delete.&apos;);        
</code></pre><p> }<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Batch has flag set”.<br>*/<br>static testMethod void batchHelperHas() {<br> batchHelper(true,null,true,’A’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises “Batch does not have flag set”.<br>*/<br>static testMethod void batchHelperHasNot() {<br> batchHelper(false,null,false,’B’);<br>}</p>
<p>/** </p>
</li>
<li><p>Exercises Batch delete.<br>*/<br>static testMethod void batchHelperDel() {<br> batchHelper(true,false,false,’C’);<br>}</p>
<p>/** </p>
</li>
<li>Exercises Batch insert.<br>*/<br>static testMethod void batchHelperIns() {<br> batchHelper(false,true,true,’D’);<br>}<br>}</li>
</ul>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/salesforce/">Salesforce</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-test-driven-development-with-apex-triggers-on-force-com" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/test-driven-development-with-apex-triggers-on-force-com/">Test Driven Development with Apex Triggers on Force.com</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2012/test-driven-development-with-apex-triggers-on-force-com/" class="article-date">
  <time datetime="2012-03-05T11:00:00.000Z" itemprop="datePublished">2012-03-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/review/">Review</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <div class="separator" style="clear:both;text-align:center;"><a href="http://en.wikipedia.org/wiki/Drawing_Hands" target="_blank" rel="external"><img src="http://upload.wikimedia.org/wikipedia/en/b/ba/DrawingHands.jpg" alt=""></a></div><a href="http://tedhusted.blogspot.com/2012/03/test-driven-development-with-apex-on.html" target="_blank" rel="external">In an earlier blog</a>, we examined a simple example of Test Driven Development (TDD). Here, we dive into a real-life example of using TDD to develop production Apex code for Salesforce CRM.<br><strong><br>How does TDD work in practice?</strong><br><br>Let’s walk through a non-trivial example of using test-driving development to craft a complex Apex trigger.<br><br><strong>Problem: </strong>An off-the-shelf integration requires the existence of a specific Salesforce CRM Opportunity object. When the object is present, the integration acts on the Account related to the Opportunity. When the object is not present. the integration bypasses the Account.<br><br><a name="more"></a><strong>User Story:</strong> As a CRM User, I need to easily manage the Opportunity that signals the integration, for example, by selecting a checkbox that creates or removes the related integration object.<br><br><strong>Solution:</strong> Provide an Account trigger that observes the checkbox and inserts or deletes the related integration object.<br><br><strong>How do we test an Apex trigger?</strong><br><br>In the case of an Apex trigger, we can’t invoke the behavior directly. The purpose of a trigger is to create a side effect when we insert, update, or delete objects. Basically, we do something like<br><br>| <span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">Account a = new Account(name = ‘test’,);</span></span><br>| <span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">insert(a);</span></span><br><br>and observe the state changes.<br><br>(Note: Another approach is to have the trigger call a worker class, and then write tests against the worker class. Here, we are using the direct approach, and keeping the trigger code in the trigger.)<br><br>As we saw in Part 1, a good place to start any coding exercise is to clearly define the expected state change. We can then code tests against the expected state changes, call the relevant DML operations (insert, update, and/or delete), and observe the outcome. (DML = Database Manipulation Language.)<br><br>Let’s express our expectations (or requirements) in the form of a documentation comment for the trigger under test.<br><div><span style="font-size:x-small;"><br></span></div><div><span style="font-size:x-small;">// Integration Account trigger requirements<br><br>/<strong><br> <em> Manages a2z Opportunity by referring to the “Do Import” checkbox on the Account object (NU_isA2zImport__c).
 </em> When an a2z Opportunity exists, the Account is imported to a2z.<br> <em> The trigger handles three transitional states:
 </em> (1) if insert and doImport, insert opportunity;<br> <em> (2) if update and !doImport and hasOpp, delete opportunity;    
 </em> (3) if update and doImport and !hasOpp, insert opportunity.<br> <em> By inference, the trigger also handles:
 </em> (4) if insert and !doImport, exit;<br> <em> (5) if update and doImport and hasOpp, exit;
 </em> (6) if !doImport and !hasOpp, exit.<br> */</strong></span></div><br>To start coding the trigger that implements this logic, according to test driven development, we need a failing test. Let’s start with (1) and write a test for the Insert case. Since this is a non-trivial example, there is some scaffolding for the test.<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Test for Insert case<br><br>final static Id A2Z_RECORD_TYPE_ID = Schema.SObjectType.Opportunity.<br>  getRecordTypeInfosByName().get(‘a2z’).getRecordTypeId();<br>final static String A2Z_STAGE_NAME = ‘Closed Won’;<br><br>/<br> <em> Exercises “Insert Import” (1) by inserting an new Account with the checkbox set,
 </em> and observing whether a corresponding Opportunity is created.<br> <em>/<br>static testMethod void testInsImp() {<br>       // Bootstrap a test account, passing in values for needed fields.<br>       Account a = new Account(name = ‘test’, NU_isA2zImport__c=true);<br>       // Insert and Select the test Account<br>       insert(a);<br>       // Do we have an a2z opp?<br>       Integer opps = [<br>                SELECT COUNT()<br>                FROM Opportunity<br>                WHERE AccountId = :a.id<br>                      AND  RecordTypeId = :A2Z_RECORD_TYPE_ID<br>                      AND StageName = :A2Z_STAGE_NAME<br>           ];<br>       Boolean hasOpp = (opps&gt;0);<br>       System.assert(hasOpp,’Expected opp on insert.’);<br>}</em></span></span><br><div style="font-family:inherit;"><br></div><div style="font-family:inherit;"><span style="font-size:small;">When we run this test, it fails, because no one has written a trigger to insert the opportunity when the checkbox is true. Next!</span></div><div style="font-family:inherit;"><br></div><div style="font-family:inherit;"><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Code for the Insert case<br><br>/**
  Manages a2z Opportunity by referring to the “Do Import” checkbox<br> <em> on the Account object.
 </em> …<br> <em>/<br>trigger NU_a2zCreateOpportunity on Account (after insert, after update) {<br><br>    final static Id A2Z_RECORD_TYPE_ID = Schema.SObjectType.Opportunity.<br>      getRecordTypeInfosByName().get(‘a2z’).getRecordTypeId();<br>    final static String A2Z_STAGE_NAME = ‘Closed Won’;<br><br>    // (1) On insert, if isImport, insert opp<br>    if (Trigger.isInsert) {<br>            List delta = new List();<br>            for (Account a : Trigger.new) {<br>                if (a.NU_isA2zImport__c) {<br>                    Opportunity o = new Opportunity(<br>                            AccountId = a.Id,<br>                            Name = ‘a2z’,<br>                            RecordTypeId = A2Z_RECORD_TYPE_ID,<br>                            StageName = A2Z_STAGE_NAME,<br>                            CloseDate = Date.Today()<br>                    );<br>                    delta.add(o);<br>               }<br>       }<br>       if (delta.size()&gt;0) insert(delta);<br>}</em></span></span></div><div style="font-family:inherit;"><br></div><div style="font-family:inherit;">When we run the test again, it succeeds, because we now have the trigger code that inserts the a2z Opportunity.<br><br>(Note: If you haven’t written Apex triggers, the for-loop might seem odd. As a performance tweak, Apex triggers work with batches. Most times, it’s a batch of one. But, if data is being imported, a batch could contain 200, or even 2000, objects to insert, update, or delete.)<br><br>Since unit testing is baked into Apex, we don’t need to undo any database operations that occur with an actual testMethod. While the testMethod is running, the trigger can insert all the opportunities it likes, but when the test ends, Force.com rolls it all back for us. No fuss. No muss. No left-over cruft.<br><br>Looking back at the code, I see things I don’t like. There are redundant constants, and we are also doing a lot of heavy lifting inline, obscuring the flow of the code. Since we have a passing test, let’s improve the design, and run the test again.<br><br>First, since we will need to share constants and helpers between the tests and the code-under-test, let’s extract existing code into a static helper class.</div><div style="font-family:inherit;"><br></div><div style="font-family:inherit;"><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Extracting a utility class to share test and domain code.<br><br>/**
  Encapsulates tools used by a2z Opportunity test and domain code.<br> <em>/<br>public Class NU_a2zOpps {<br><br>    /**
     </em> Defines an a2z Opp with a particular Record Type ID and Stage Name.<br>     <em> (TODO: Transfer to custom settings and expose to validation rule.)
     </em>/<br>    final static public String A2Z_STAGE_NAME = ‘Closed Won’;<br>    final static public Id A2Z_RECORD_TYPE_ID = Schema.SObjectType.Opportunity.<br>      getRecordTypeInfosByName().get(‘a2z’).getRecordTypeId();<br><br>    /<strong><br>     <em> Declares a default name for generated opportunities.
     </em>/<br>    static public String A2Z_NAME = ‘a2z Import’;<br><br>    /</strong><br>     <em> Returns a ready-to-use a2z Opportunity.
     </em>/<br>    static public Opportunity newOpp(Account a) {<br>            return new Opportunity(<br>                    AccountId = a.Id,<br>                    RecordTypeId = A2Z_RECORD_TYPE_ID,<br>                    Name = A2Z_NAME,<br>                    StageName = A2Z_STAGE_NAME,<br>                    CloseDate = Date.Today()<br>            );<br>    }<br><br>    /<strong><br>     <em> Determines if a given Account has an A2z Opportunity.
     </em>/<br>    static public Boolean hasOpp(Account a) {<br>            Integer opps = [<br>                  SELECT COUNT()<br>                  FROM Opportunity<br>                  WHERE AccountId = :a.id<br>                      AND RecordTypeId = :A2Z_RECORD_TYPE_ID<br>                      AND StageName = :A2Z_STAGE_NAME<br>                ];<br>            return (opps&gt;0);<br>    }<br>}</strong></span></span></div><div style="font-family:inherit;"></div><div style="font-family:inherit;"><br>Replacing the extracted code with references to the static class, our test and trigger are now easier to follow.</div><div style="font-family:inherit;"><br></div><div style="font-family:inherit;"><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Test and domain classes refactored to use new utility class.<br><br>@isTest<br>private class NU_TEST_a2zCreateOpportunity {<br><br>    /<br>      <em> Generates an account with the NU_isA2zImport__c raised or lowered.
      </em> Assumes default is false.<br>      <em>/<br>    static Account newAccount(Boolean doImport) {<br>            Account a = new Account(Name = ‘Test Account’,<br>            CompanyNumber<strong>c = ‘1’;<br>            if (doImport) a.NU_isA2zImport</strong>c = true; // False is default<br>            return a;<br>    }<br><br>    /**
      </em> Inserts the given account, and returns it again from a select.<br>      <em>/<br>    static Account doInsert(Account a) {<br>            insert(a);<br>            return [<br>                SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c<br>                FROM Account<br>                WHERE id = :a.id<br>            ];<br>    }<br><br>    /**
     </em> Exercises “Insert Import”.<br>     <em>/<br>    static testMethod void testInsImp() {<br>            Account a = newAccount(true);<br>            Account a2 = doInsert(a);<br>            System.assert(NU_a2zOpps.hasOpp(a2), ‘Expected opp on insert.’);<br>    }<br>}<br><br>trigger NU_a2zCreateOpportunity on Account (after insert, after update) {<br>    // (1) On insert, if isImport, insert opp<br>    if (Trigger.isInsert) {<br>            List delta = new List();<br>            for (Account a : Trigger.new) {<br>                    if (a.NU_isA2zImport__c) {<br>                        delta.add(NU_a2zOpps.newOpp(a));<br>                    }<br>            }<br>            if (delta.size()&gt;0) insert delta ;<br>    }<br>}</em></span></span></div><div style="font-family:inherit;"><span style="font-size:small;"><br></span></div>We implemented the first requirement using a classic TDD pattern:<br><div style="font-family:inherit;">

   Create a failing test that proves a desired behavior is not present.<br><em>   Write just enough code to pass the test.
</em>   Once the test succeeds, improve the design (refactor) so that it’s easy to maintain.Let’s continue to follow the TDD pattern with our second requirement: “if update and !doImport and hasOpp, delete opp”.<br>First, the failing test:<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Test deleting a related opportunity </span></span><br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">static testMethod void testUpdImpNoImp() {</span><br><span style="font-family:'Courier New', Courier, monospace;">    Account a = newAccount(true); // Import</span><br><span style="font-family:'Courier New', Courier, monospace;">    Account a2 = doInsert(a); <strong>// Line 2</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">    a2.NU_isA2zImport<strong>c = false; // No Import</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">    update a2; <strong>// Line 4</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">    System.assert(!NU_a2zOpps.hasOpp(a2),’Expected no opps on update.’);</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></span><br><br>When  we run the test, it fails, because our trigger inserts a new a2z  Opportunity (at line 2) but does not delete the Opportunity (at line 4).<br><br>OK,  let’s update the trigger to provide the behavior expected by line 4. As  before, we need to write the trigger to loop through a batch, while  minimizing database calls to stay within governor limits.<br><span style="font-size:x-small;"><br><span style="font-family:'Courier New', Courier, monospace;">// (2) On update, if not isImport and haveOpp, delete opp</span><span style="font-family:'Courier New', Courier, monospace;"> </span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">if (Trigger.isUpdate) {</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">           </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">Map opps = NU_a2zOpps.getOpps(Trigger.new);</span><br><span style="font-family:'Courier New', Courier, monospace;">           Set ids = opps.Keyset();</span><br><span style="font-family:'Courier New', Courier, monospace;">           List omega = new List();</span><br><span style="font-family:'Courier New', Courier, monospace;">           for (Account a : Trigger.new) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                   if ( !a.NU_isA2zImportc &amp;&amp; ids.contains(a.Id)) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                       omega.add(opps.get(a.Id)); // (2)</span><br><span style="font-family:'Courier New', Courier, monospace;">                   }  </span><br><span style="font-family:'Courier New', Courier, monospace;">           }</span><br><span style="font-family:'Courier New', Courier, monospace;">           if (omega.size()&gt;0) delete omega;</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></span><br><br>The  crux of the code change is determining if we have a related opportunity  to delete. Easy enough with one Account, but in the case of a trigger,  we might have to check 200 accounts, and <a href="http://www.salesforce.com/us/developer/docs/apexcode/Content/apex_gov_limits.htm" target="_blank" rel="external">our query limit is only 100</a>.  Since the trigger passes us the set of Accounts in the batch, it’s not  difficult to retrieve the set of Opportunities related to those  Accounts. Though, now that we have a utility class, we should keep the  query details encapsulated behind another helper method.<br><br>The <span style="font-family:'Courier New', Courier, monospace;">getOpps</span> helper method returns a Map itemizing the accounts  in our batch that have related a2z opportunities.<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// The getOpps helper method </span><br><br><span style="font-family:'Courier New', Courier, monospace;">static public Map getOpps(List accounts) {    </span><br><span style="font-family:'Courier New', Courier, monospace;">        List oppsList = new List();</span><br><span style="font-family:'Courier New', Courier, monospace;">        Map opps = new Map();</span><br><span style="font-family:'Courier New', Courier, monospace;">        Integer count = [</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">                </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">SELECT COUNT() </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">                </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">FROM Opportunity </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">                </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">WHERE RecordTypeId = :A2Z_RECORD_TYPE_ID </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">                    </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">AND StageName = :A2Z_STAGE_NAME </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">                    </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">AND AccountId IN :accounts</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">];</span><br><span style="font-family:'Courier New', Courier, monospace;">        if (count&gt;0) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                oppsList = [</span><br><span style="font-family:'Courier New', Courier, monospace;">                    SELECT AccountId FROM Opportunity</span><br><span style="font-family:'Courier New', Courier, monospace;">                    WHERE RecordTypeId = :A2Z_RECORD_TYPE_ID</span><br><span style="font-family:'Courier New', Courier, monospace;">                        AND StageName = :A2Z_STAGE_NAME</span><br><span style="font-family:'Courier New', Courier, monospace;">                        AND AccountId IN :accounts</span><br><span style="font-family:'Courier New', Courier, monospace;">                ];</span><br><span style="font-family:'Courier New', Courier, monospace;">                for (Opportunity o : oppsList) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                    opps.put(o.AccountId,o);</span><br><span style="font-family:'Courier New', Courier, monospace;">                }</span><br><span style="font-family:'Courier New', Courier, monospace;">        }</span><br><span style="font-family:'Courier New', Courier, monospace;">        return opps;</span><br><span style="font-family:'Courier New', Courier, monospace;">}    </span></span><br><br>A critical clause in the helper’s SELECT statement is “<span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">AccountId IN :accounts</span></span>“.  This clause ensures that we only retrieve the Opportunities that are  related to Accounts in the current batch. Without this clause, we could  retrieve more Opportunities than allowed by the Force.com governor  (50,000). The helper also makes a point of returning an empty Map if  there are no matching opportunities, simplifying life for the caller.<br><br>While  we’ve been coding the trigger to act on a batch, our tests have not  been passing a batch of objects to the trigger. Let’s add a test to be  sure batch mode is working.<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Test to verify that insert works with batches of records</span><br><br><span style="font-family:'Courier New', Courier, monospace;">/<strong></strong></span><br><span style="font-family:'Courier New', Courier, monospace;"> <em> Exercise Insert Import in batch mode.</em></span><br><span style="font-family:'Courier New', Courier, monospace;"> /</span><br><span style="font-family:'Courier New', Courier, monospace;">static testMethod void verifyBatchInsert() {</span><br><span style="font-family:'Courier New', Courier, monospace;">        List rows = new List();</span><br><span style="font-family:'Courier New', Courier, monospace;">        for (Integer r=0; r&lt;200; r++) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                rows.add(newAccount(true, r));</span><br><span style="font-family:'Courier New', Courier, monospace;">        }</span><br><span style="font-family:'Courier New', Courier, monospace;">        insert(rows);</span><br><span style="font-family:'Courier New', Courier, monospace;">        List inserted = [</span><br><span style="font-family:'Courier New', Courier, monospace;">              SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c</span><br><span style="font-family:'Courier New', Courier, monospace;">              FROM Account</span><br><span style="font-family:'Courier New', Courier, monospace;">              WHERE id in :rows</span><br><span style="font-family:'Courier New', Courier, monospace;">        ];</span><br><span style="font-family:'Courier New', Courier, monospace;">        Set ids = NU_a2zOpps.getOpps(inserted).Keyset();</span><br><span style="font-family:'Courier New', Courier, monospace;">          Boolean  success = true;</span><br><span style="font-family:'Courier New', Courier, monospace;">          for (Account a : inserted) {        </span><br><span style="font-family:'Courier New', Courier, monospace;">                   success = success &amp;&amp; ids.contains(a.Id);            </span><br><span style="font-family:'Courier New', Courier, monospace;">          }</span><br><span style="font-family:'Courier New', Courier, monospace;">          System.assert(success,’Expected opps on batch insert.’);</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></span><br><br>Running  the test, initially, we hit a problem with a helper method. This  particular organization includes an external ID that must be unique for  each record. In batch mode, our external IDs are not unique, and so we  hit a validation error. A quick fix is to pass in the counter from the  loop, creating a serial number for each Account.<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// newAccount with offset parameter </span></span><br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">static Account newAccount(Boolean doImport, Integer offset<strong>) {</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">        Account a = new Account(</span><br><span style="font-family:'Courier New', Courier, monospace;">                Name = ‘Test Account’,</span><br><span style="font-family:'Courier New', Courier, monospace;">                CompanyNumber<strong>c = String.valueOf(offset)</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">        );</span><br><span style="font-family:'Courier New', Courier, monospace;">        if (doImport) a.NU_isA2zImportc = true; // False is default</span><br><span style="font-family:'Courier New', Courier, monospace;">        return a;</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span><br><br><span style="font-family:'Courier New', Courier, monospace;">// for backward-compatibility</span><br><span style="font-family:'Courier New', Courier, monospace;">static Account newAccount(Boolean doImport) {</span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">        </span></span><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">return newAccount(doImport, 0);</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></span><br><br>And, a batch delete test.<br><br><div><span style="font-size:x-small;">// batchDelete </span></div><div><br></div><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">static testMethod void batchDelete() {</span><br><span style="font-family:'Courier New', Courier, monospace;">        List rows = new List();</span><br><span style="font-family:'Courier New', Courier, monospace;">            for (Integer r=0; r&lt;200; r++) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                rows.add(newAccount(true, r));</span><br><span style="font-family:'Courier New', Courier, monospace;">        }</span><br><span style="font-family:'Courier New', Courier, monospace;">        insert rows;</span><br><span style="font-family:'Courier New', Courier, monospace;">        List inserted = [</span><br><span style="font-family:'Courier New', Courier, monospace;">               SELECT id, NU_isA2zImport<strong>c, CompanyNumber</strong>c</span><br><span style="font-family:'Courier New', Courier, monospace;">               FROM Account</span><br><span style="font-family:'Courier New', Courier, monospace;">               WHERE id in :rows</span><br><span style="font-family:'Courier New', Courier, monospace;">        ];</span><br><span style="font-family:'Courier New', Courier, monospace;">        for (Account a : inserted) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                a.NU_isA2zImport<strong>c = false;</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">        }</span><br><span style="font-family:'Courier New', Courier, monospace;">        update inserted;</span><br><span style="font-family:'Courier New', Courier, monospace;">        Set ids = NU_a2zOpps.getOpps(inserted).Keyset();        </span><br><span style="font-family:'Courier New', Courier, monospace;">        Boolean success = true;</span><br><span style="font-family:'Courier New', Courier, monospace;">        for (Account a : inserted) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                success = success &amp;&amp; !ids.contains(a.Id);            </span><br><span style="font-family:'Courier New', Courier, monospace;">        }</span><br><span style="font-family:'Courier New', Courier, monospace;">        System.assert(success,’Expected no opps on batch delete.’);        </span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></span><br><br>Both  of the new tests are passing, but they seem to repeat a lot of code,  and we have a third requirement coming up that will also need batch mode  testing. Let’s see if we can create a helper class that can serve both  tests.<br><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// batchHelper method</span></span><br><span style="font-size:x-small;"><br><span style="font-family:'Courier New', Courier, monospace;">static void batchHelper(Boolean insImp) {</span><br><span style="font-family:'Courier New', Courier, monospace;">       List rows = new List();</span><br><span style="font-family:'Courier New', Courier, monospace;">       for (Integer r=0; r&lt;200; r++) {</span><br><span style="font-family:'Courier New', Courier, monospace;">               rows.add(newAccount(insImp, r));</span><br><span style="font-family:'Courier New', Courier, monospace;">       }</span><br><span style="font-family:'Courier New', Courier, monospace;">       insert rows;</span><br><span style="font-family:'Courier New', Courier, monospace;">       List inserted = [</span><br><span style="font-family:'Courier New', Courier, monospace;">               SELECT id, NU_isA2zImportc, CompanyNumber<strong>c</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">               FROM Account</span><br><span style="font-family:'Courier New', Courier, monospace;">               WHERE id in :rows</span><br><span style="font-family:'Courier New', Courier, monospace;">       ];</span><br><span style="font-family:'Courier New', Courier, monospace;">       // For delete, we need to update the flag</span><br><span style="font-family:'Courier New', Courier, monospace;">       if (!insImp) {</span><br><span style="font-family:'Courier New', Courier, monospace;">               for (Account a : inserted) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                       a.NU_isA2zImportc = false;            </span><br><span style="font-family:'Courier New', Courier, monospace;">               }</span><br><span style="font-family:'Courier New', Courier, monospace;">               update inserted;</span><br><span style="font-family:'Courier New', Courier, monospace;">       }</span><br><span style="font-family:'Courier New', Courier, monospace;">       Set ids = NU_a2zOpps2.getOpps(inserted).Keyset();        </span><br><span style="font-family:'Courier New', Courier, monospace;">       Boolean success = true;</span><br><span style="font-family:'Courier New', Courier, monospace;">       if (insImp) {</span><br><span style="font-family:'Courier New', Courier, monospace;">               for (Account a : inserted) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                       success = success &amp;&amp; ids.contains(a.Id);            </span><br><span style="font-family:'Courier New', Courier, monospace;">               }</span><br><span style="font-family:'Courier New', Courier, monospace;">               System.assert(success,’Expected opps on batch insert.’);</span><br><span style="font-family:'Courier New', Courier, monospace;">       } else {</span><br><span style="font-family:'Courier New', Courier, monospace;">               for (Account a : inserted) {</span><br><span style="font-family:'Courier New', Courier, monospace;">                       success = success &amp;&amp; !ids.contains(a.Id);            </span><br><span style="font-family:'Courier New', Courier, monospace;">               }</span><br><span style="font-family:'Courier New', Courier, monospace;">               System.assert(success,’Expected no opps on batch delete.’);        </span><br><span style="font-family:'Courier New', Courier, monospace;">       }</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span><br><br><span style="font-family:'Courier New', Courier, monospace;">/</span><br><span style="font-family:'Courier New', Courier, monospace;"> <em> Exercises Batch insert.</em></span><br><span style="font-family:'Courier New', Courier, monospace;"> /</span><br><span style="font-family:'Courier New', Courier, monospace;">static testMethod void batchHelperIns() {</span><br><span style="font-family:'Courier New', Courier, monospace;">    batchHelper(false);</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span><br><br><span style="font-family:'Courier New', Courier, monospace;">/<em>*</em></span><br><span style="font-family:'Courier New', Courier, monospace;">  Exercises Batch delete.</span><br><span style="font-family:'Courier New', Courier, monospace;"> <em>/</em></span><br><span style="font-family:'Courier New', Courier, monospace;">static testMethod void batchHelperDel() {</span><br><span style="font-family:'Courier New', Courier, monospace;">    batchHelper(true);</span><br><span style="font-family:'Courier New', Courier, monospace;">}    </span></span><br><br>By passing a flag, we are able to use one utility for both cases, and share 90% of the code.<br><br>Repeating  the patterns we’ve seen, we can test and refactor our way into a  robust, reliable trigger to manage our integration object.<br><br>For the complete production source  code (without the play-by-play), see <a href="http://tedhusted.blogspot.com/2012/03/managing-related-object-via-checkbox-in.html" target="_blank" rel="external">Managing a Related Object via a  Checkbox in Salesforce CRM</a>.<br><div style="font-family:inherit;"><br></div>Key takeaways are: 

   Use a utility class to share code between test and domain classes.<br><em>   Use helper methods to share code between similar test methods.
</em>   Use the SELECT-IN-SET pattern to keep triggers within governor limits.Test Driven Development is a rigorous, structured approach that  helps us create robust and reliable code. Since TDD uses successive  refinement, we can easily extend and improve the code over time.</div><div style="font-family:inherit;"><br></div>
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/force-com/">Force.com</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-test-driven-development-with-apex-on-force-com" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/test-driven-development-with-apex-on-force-com/">Test Driven Development with Apex on Force.com</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2012/test-driven-development-with-apex-on-force-com/" class="article-date">
  <time datetime="2012-03-04T11:00:00.000Z" itemprop="datePublished">2012-03-04</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/review/">Review</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><div class="separator" style="clear:both;text-align:center;"><a href="http://teachingunderground.blogspot.com/2011/04/catching-carrot-and-breaking-stick.html" target="_blank" rel="external"><img src="https://tedhusted.files.wordpress.com/2012/03/968d3-carrot-with-stick.jpg" alt=""></a></div><br>As far as I know, Force.com – the software development platform for Salesforce CRM – is the only platform that <strong>requires</strong> unit test coverage for production code. Before an Apex developer can deploy custom code to a production environment, the overall unit test coverage for the environment must be 75% or better.</p>
<p><span style="font-size:large;"><strong><span style="font-size:small;">What is Unit Test Coverage?</span></strong></span></p>
<p>Let’s look at a simplistic, contrived example of unit test coverage. For demonstration purposes, the <span style="font-family:'Courier New', Courier, monospace;">HelloWorld</span> Class shows an Apex function that tests whether the text of a string matches “Hello World” or not.<br><a name="more"></a><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// HelloWord Class</span></span></p>
<p><span style="font-family:'Courier New', Courier, monospace;">public class HelloWorld {</span><span style="font-family:'Courier New', Courier, monospace;"><br>public static String isHelloWorld(String myString) {</span><br><span style="font-family:'Courier New', Courier, monospace;">    if (myString.equals(‘Hello World’)) return ‘Yes it is!’; <strong>// Line 1</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">    else return ‘No it is not!’: <strong>// Line 2</strong></span><br><span style="font-family:'Courier New', Courier, monospace;">  }</span><br><span style="font-family:'Courier New', Courier, monospace;">}</span></p>
<p>The <span style="font-family:'Courier New', Courier, monospace;">verifyIsHelloWorld</span> test method exercises our gratuitous example</p>
<p><span style="font-family:'Courier New', Courier, monospace;font-size:x-small;">// verifyIsHelloWorld test method</span></p>
<p>@isTest<br>private class TEST_HelloWorld {<br>static testMethod void verifyIsHelloWorld () {<br>String outcome = HelloWorld.isHelloWorld (‘Hello World’);<br>System.assert(outcome == ‘Yes it is!’, ‘Expected positive message.’) ;<br>}<br>}</p>
<p>At this point, we have 66% test coverage, because our test exercises only one of the two statements in <span style="font-family:'Courier New', Courier, monospace;">isHelloWorld</span> (line 1).</p>
<p>To bring test coverage up to 100%, we need to add another test method.</p>
<p><div><span style="font-size:x-small;"> </span></div></p>
<div>

<p><span style="font-size:x-small;">// Another test method</span></p>
<p>static testMethod void verifyIsHelloWorldFalse() {<br>String outcome = HelloWorld.isHelloWorld (‘Hello Kitty’);<br>System.assert(outcome == ‘No it is not!’, ‘Expected negative message.’) ;<br>}</p>
<p></p></div><br>With both of these test methods in play, our code now has 100% coverage.<p></p>
<p><strong>Why is test coverage important?</strong></p>
<p>Salesforce.com has high standards for its own code and expects custom Apex code to also be robust and error-free. One of the best ways to increase code quality is to encourage developers to write unit tests. <a href="http://nparc.cisti-icist.nrc-cnrc.gc.ca/npsi/ctrl?action=shwart&amp;index=an&amp;req=5763742&amp;lang=en" target="_blank" rel="external">Witness a 2005 study found that unit tests increased both coder productivity and code quality.</a></p>
<p>While it’s possible for developers to boost code coverage with pointless tests, hardcore coders see unit tests as a way to release better code sooner – the keyword being “release”. The time spent on proactive unit testing is a trade-off with the time spent on reactive debugging. We can find our own bugs ourselves with unit tests, or wait and fix them later when a feature comes back with a QA ticket attached.</p>
<p>In my own work, I’ve found that the best way to ensure that code has adequate test coverage to practice test-driven development (TDD).</p>
<p><strong>What is Test Driven Development (TDD)?</strong></p>
<p>For the uninitiated, a classic way to bootstrap unit testing (and TDD) is to start with defect reports. Before fixing a bug, a developer first writes a test that proves that the defect exists. For example, if someone reports that <span style="font-family:'Courier New', Courier, monospace;">isHelloWorld</span> fails if we pass in a null string, we could start with a test like the one shown by <span style="font-family:'Courier New', Courier, monospace;">verifyIsHelloWorldNull</span>.</p>
<p><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// verifyIsHelloWorldNull</span></span></p>
<p>static testMethod void verifyIsHelloWorldNull() {<br>String outcome = HelloWorld.isHelloWorld (null);<br>System.assert(outcome == ‘No it is not!’, ‘Expected negative message.’) ;<br>}</p>
<p><div style="font-family:inherit;"></div></p>
<p><div style="font-family:inherit;"><span style="font-size:x-small;"> </span></div><br>If we run this test, it raises an exception “System.NullPointerException: Attempt to de-reference a null object”.</p>
<p>Since an exception counts as a failing test, we can proceed with the fix, say, by changing the code from:</p>
<p>| <span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">if (myString.equals(‘Hello World’)) return ‘Yes it is!’; <strong>// Line 1</strong></span></span></p>
<p>to:</p>
<p>| <span style="font-family:'Courier New', Courier, monospace;font-size:x-small;">if ‘HelloWorld’.equals(‘myString’) return ‘Yes it is!’; <strong>// Line 1</strong></span></p>
<p>and maybe, for good measure, including a fourth test case for an empty string.</p>
<div>

<p><span style="font-size:x-small;">// Test for empty String</span></p>
<p>final static String EMPTY = ‘’;<br>static testMethod void verifyIsHelloWorldEmpty() {<br>String outcome = HelloWorld.isHelloWorld (EMPTY);<br>System.assert(outcome == ‘No it is not!’, ‘Expected negative message.’) ;<br>}</p>
<p></p></div><br><span style="font-family:inherit;">Once all of our tests are passing, we could even refactor the code, and improve the internal design by using a constant and a single comparison.</span><p></p>
<div>

<p><span style="font-size:x-small;">// Code refactored</span></p>
<p>public class HelloWorld {<br>public final static String HELLO_WORLD = ‘Hello World’;<br>public final static String YES_WORLD = ‘Yes it is!’;<br>public final static String NO_WORLD = ‘No it is not!’;<br>public static String isHelloWorld(String myString) {<br>return (HELLO_WORLD.equals(myString)) ? YES_WORLD : NO_WORLD;<br>}<br>}</p>
<p></p></div><br><span style="font-family:inherit;">If our tests pass (they do), we can be confident that our refactoring did not break the code’s external behavior. Passing tests give us the courage to refine existing code and improve the internal design.</span><p></p>
<p>The key idea behind TDD is to “never write a line of code without a failing test”. If we are going to write the test anyway, better to write it first, code to the test, and receive full benefit for the time we invest.</p>
<p><strong>How do we test code that doesn’t exist?</strong></p>
<p>In an Apex environment, a unit test usually operates at the class level. To bootstrap testing a class or method that does not exist, we can start coding the test, create a stub class with stub methods, sufficient to compile the test, confirm that it fails, and then fill-in functionality to pass the test.</p>
<p>Let’s start over from scratch. First, we should define our requirements for the <span style="font-family:'Courier New', Courier, monospace;">isHelloWorld</span> method.</p>
<p><span style="font-family:inherit;"> <span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// isHelloWorld requirements</span></span></span></p>
<p>/**</p>
<ul>
<li>The isHelloWorld method determines if a String equals ‘Hello World’.</li>
<li>(1) Given the String ‘Hello World’, the method returns “Yes, it Is.”</li>
<li>(2) Given some other String, the method returns ‘No, it is not!’.</li>
<li>(3) Given a null or empty string, the method returns ‘No, it is not!’.<br>*/<br><div style="font-family:inherit;"></div><br><div style="font-family:inherit;"><span style="font-size:small;">Then, we can write a “happy path” test for the first requirement.</span></div><br><div style="font-family:inherit;"></div><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// A happy path test for requirement (1)</span></span></li>
</ul>
<p>final static String POSITIVE = ‘Expected positive message.’;<br>static testMethod void verifyIsHelloWorld () {<br>String outcome = HelloWorld.isHelloWorld (‘Hello World’);<br>System.assert(outcome == HelloWorld.YES_WORLD,POSITIVE ) ;<br>}<span style="font-family:inherit;"> </span></p>
<p><div style="font-family:inherit;"><span style="font-size:small;">provide a stub Hello World class to compile the test</span></div></p>
<p><div style="font-family:inherit;"><span style="font-size:x-small;"> </span></div><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><br>// A HelloWorld stub class</span></span></p>
<p>public class HelloWorld {<br>public static String isHelloWorld(String myString) {<br>return null;<br>}<br>}</p>
<p><div style="font-family:inherit;"><span style="font-size:small;">add just enough behavior to pass one test for one requirement</span></div><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><span style="font-size:small;"><br></span>// Coding requirement (1)</span></span></p>
<p>public final static String HELLO_WORLD = ‘Hello World’;<br>public final static String YES_WORLD = ‘Yes it is!’;</p>
<p>public static String isHelloWorld(String myString) {<br>return HELLO_WORLD.equals(myString) ? YES_WORLD : return null;<br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">}</span></span></p>
<p><div style="font-family:inherit;"></div></p>
<p><div style="font-family:inherit;"><span style="font-size:small;">then another requirement</span></div><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><br>// Testing requirement (2)</span></span></p>
<p>final static String NEGATIVE =’Expected negative message.’;<br>static testMethod void verifyIsHelloWorldFalse () {<br>String outcome = HelloWorld.isHelloWorld (‘Hello Kitty’);<br>System.assert(outcome == HelloWorld.NO_WORLD,NEGATIVE ) ;<br>}</p>
<p>// Coding requirements (1) and (2)</p>
<p>public final static String HELLO_WORLD = ‘Hello World’;<br>public final static String YES_WORLD = ‘Yes it is!’;<br>public final static String NO_WORLD = ‘No it is not!’;</p>
<p>public static String isHelloWorld(String myString) {<br>return HELLO_WORLD.equals(myString) ? YES_WORLD : NO_WORLD;<br>}</p>
<p><div style="font-family:inherit;"><span style="font-size:small;">and a third</span></div><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">  </span></span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;">// Testing requirement (3)</span></span></p>
<p>static testMethod void verifyIsHelloWorldNull() {<br>String outcome = HelloWorld.isHelloWorld (null);<br>System.assert(outcome == HelloWorld.NO_WORLD,NEGATIVE );<br>}</p>
<p>final static String EMPTY = ‘’;<br>static testMethod void verifyIsHelloWorldEmpty() {<br>String outcome = HelloWorld.isHelloWorld (EMPTY);<br>System.assert(outcome == HelloWorld.NO_WORLD,NEGATIVE );<br>}<br><span style="font-family:inherit;font-size:small;"><span style="font-family:'Courier New', Courier, monospace;"> </span> </span><br><span style="font-family:inherit;font-size:small;">For requirement 3, we added two test methods, but did not need to change any code, since the current implementation passed the tests.</span></p>
<p>To fully test the method, we might also <a href="http://developer.force.com/cookbook/recipe/construct-random-strings-of-large-sizes-in-your-apex-tests" target="_blank" rel="external">add a test for a string of maximum length</a>, so that we test both boundaries. But, as it stands, we have 100% test coverage, and a test for each stated requirement, which meets my own personal “definition of done”.</p>
<p>Three takeaways from this exercise are:</p>
<ul>
<li><span style="font-family:inherit;font-size:small;"> Never write a line of code without a failing test.</span></li>
<li><span style="font-family:inherit;font-size:small;"> Test every requirement, one requirement at a time.</span></li>
<li><span style="font-family:inherit;font-size:small;"> Passing tests give us the courage to refactor.</span><br><span style="font-family:inherit;font-size:small;"> In a followup blog, <a href="http://tedhusted.blogspot.com/2012/03/test-driven-development-with-apex.html" target="_blank" rel="external">TDD with Apex Triggers,</a> we look at how Test Driven Development works in practice, with a real-life non-trivial example.</span><br><span style="font-size:x-small;"><span style="font-family:'Courier New', Courier, monospace;"><span style="font-family:inherit;"></span></span></span></li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/force-com/">Force.com</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-keeping-salesforce-implementations-on-track-with-milestones-pm-and-changeit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/keeping-salesforce-implementations-on-track-with-milestones-pm-and-changeit/">Keeping Salesforce Implementations on Track with Milestones PM and ChangeIT</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2012/keeping-salesforce-implementations-on-track-with-milestones-pm-and-changeit/" class="article-date">
  <time datetime="2012-01-04T14:01:00.000Z" itemprop="datePublished">2012-01-04</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/review/">Review</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>A secret to the success of Salesforce CRM is how easy it is to customize and extend. Out of the box, Salesforce provides new users with a world-class framework for enabling collaboration between staff members and customers, or between staff and staff, or even between customers and customers (if you dare!). If that wasn’t enough, Salesforce provides a variety of ways to tailor your instance of the framework, so that it fits your own processes like a glove. </p>
<p>When folks first implement Salesforce, it’s easy to get carried away. Salesforce CRM can do so much, it’s tempting (but not practical) to try and do everything at once. In fact, Salesforce.com recommends that people spread out customization plans, so that refinement becomes an ongoing process. </p>
<p>Happily, two of the many Salesforce extensions include a project tracking app called “<a href="http://appexchange.salesforce.com/listingDetail?listingId=a0N30000005tvt6EAA" target="_blank" rel="external">Milestones PM</a>“ and a change tracking app called “<a href="http://appexchange.salesforce.com/listingDetail?listingId=a0N300000016ct3EAA" target="_blank" rel="external">ChangeIt</a>“. You can use Milestones PM to organize implementation projects, and ChangeIt to gather and prioritize new change requests. Both can be installed into your environment from the <a href="http://appexchange.salesforce.com/home" target="_blank" rel="external">Salesforce AppExchange</a>, free of additional charge.</p>
<p><strong>Milestones PM</strong></p>
<p>Milestones PM is an elegant approach to project tracking that makes it easy to capture and follow a classic work breakdown structure. It’s a great fit for IT projects, but the app would work just as well for any type of task-based project, such as organizing a retreat, publishing a newsletter, or planning an office move. </p>
<p>The application uses six objects to track progress: Project, Log, Milestone, Task, Time, and Expense, as shown in the illustration.</p>
<p><a href="https://tedhusted.files.wordpress.com/2012/01/9ef16-6a00d8341cded353ef014e5f4794a0970c-pi.png" target="_blank" rel="external"><img src="https://tedhusted.files.wordpress.com/2012/01/9ef16-6a00d8341cded353ef014e5f4794a0970c-pi.png?w=300" alt=""></a><strong>Project</strong> is the top-level container for the other five objects. Aside from tracking key details – like a Kick-Off Date, Deadline, and Description – a Project contains a set of Milestones, along with an optional Log records.</p>
<p><strong>Logs</strong> are generic memo records that you can attach to a Project, Task, Time, or Expense record. Logs can be used to capture any miscellaneous detail that doesn’t fit neatly into the other fields. </p>
<p><strong>Milestones</strong> are the key organizing object within a project. To be useful, a Project must contain at least one Milestone record, which in turn can contain Task, Time, or Expense records. Milestones can have their own Kickoff and Deadline Dates, and be linked to Parent, Predecessor, or Successor Milestones. While not as featureful as Microsoft Project dependencies, good use of the Parent, Predecessor, and Successor Milestone groupings can make complex projects easier to understand and navigate. </p>
<p>The backbone of any project are the <strong>Tasks</strong>. Every Task must have a Name and be assigned to a Milestone, and can also track an Assignee, Start and Due Dates, statuses like Priority (0-4), Stage (In progress, Resolved, Closed) and Class (Ad Hoc, Defect, Rework), Estimates, and other properties. </p>
<p><strong>Time</strong> and <strong>Expense</strong> records can be attached to Tasks, which are tallied as part of the Project’s overall metrics. </p>
<p><a href="https://tedhusted.files.wordpress.com/2012/01/17a07-mpm-dashboard.png" target="_blank" rel="external"><img src="https://tedhusted.files.wordpress.com/2012/01/17a07-mpm-dashboard.png?w=300" alt=""></a>As shown in the screen shot, Milestones PM makes excellent use of native Salesforce metrics, and integrates with other native features like Chatter and Calendar It also supports batch operations based on views and comes bundled with two dozen ready-to-run Reports.</p>
<p>Even better, Milestones PM is an <a href="http://appexchange.salesforce.com/results?filter=9&amp;sort=6&amp;type=Apps" target="_blank" rel="external">Aloha App</a>, so it doesn’t count against the number of tabs or objects your Salesforce instance consumes.</p>
<p><strong>ChangeIT</strong></p>
<p>Like housework, a good Salesforce implementation is never done. The platform is so flexible and so deep, there will always be ways to make it work even better for your users. The ChangeIT application provides a vehicle for tracking new features and fixes (which you could then turn into Milestone PM tasks).</p>
<p>In a nutshell, ChangeIT provides a simple way to manage changes to your Salesforce instance, and to notify team members when changes are scheduled or implemented. It also helps coordinate change requests, so developers and administrators are not stepping on each other.</p>
<p><div class="separator" style="clear:both;text-align:center;"><a href="https://tedhusted.files.wordpress.com/2012/01/5f96e-changeit.png" target="_blank" rel="external"><img src="https://tedhusted.files.wordpress.com/2012/01/5f96e-changeit.png?w=300" alt=""></a></div>The application provides a single, simple tab with a form for making change requests, as shown in the illustration.</p>
<p>Saving the initial request triggers an approval workflow to the individuals that you set up. Once the initial request is approved or denied, the request can be worked on by developers or administrators (and/or transferred to Milestones PM). The application also includes a dashboard and supporting reports to view the pipeline of request changes. </p>
<p>Since the applications are independent, you can use either or both – your instance, your choice!</p>
<p>We’re always exploring better approaches to project tracking, with applications like Basecamp, Tom’s Planner, JIRA, and OnTime. Do you have a favorite tool? What features do you love? What features do you miss?</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/salesforce/">Salesforce</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/9/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" href="/page/11/">Next &raquo;</a>
      </nav>
    </section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Ted Husted&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    
<script>
  var disqus_shortname = 'ted-husted-com';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>